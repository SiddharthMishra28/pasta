DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'source_schema'
    LOOP
        EXECUTE format(
            'CREATE TABLE target_schema.%I (LIKE source_schema.%I INCLUDING ALL);',
            r.tablename,
            r.tablename
        );

        EXECUTE format(
            'INSERT INTO target_schema.%I SELECT * FROM source_schema.%I;',
            r.tablename,
            r.tablename
        );
    END LOOP;
END $$;


---------------------------------------------------------


-- Migration for FlowExecution primary key change
-- Run BEFORE deploying new code

BEGIN;

-- 1. Add new columns (Postgres way)
ALTER TABLE flow_executions
    ADD COLUMN id BIGINT,
    ADD COLUMN execution_uuid VARCHAR(36);

-- 2. Populate data (preserve existing UUIDs)
-- MySQL variables + ordered update â†’ CTE + row_number()

WITH ordered AS (
    SELECT
        id AS old_id,
        ROW_NUMBER() OVER (ORDER BY created_at ASC) AS new_id
    FROM flow_executions
)
UPDATE flow_executions fe
SET
    execution_uuid = o.old_id,
    id = o.new_id
FROM ordered o
WHERE fe.id = o.old_id;

-- 3. Rename category column
ALTER TABLE flow_executions
    RENAME COLUMN category TO flow_group_name;

-- 4. Update PipelineExecution foreign key column type
ALTER TABLE pipeline_executions
    ALTER COLUMN flow_execution_id TYPE BIGINT
    USING flow_execution_id::BIGINT;

-- 5. Drop old primary key and add new one
ALTER TABLE flow_executions
    DROP CONSTRAINT flow_executions_pkey;

ALTER TABLE flow_executions
    ADD CONSTRAINT flow_executions_pkey PRIMARY KEY (id);

-- 6. Add UNIQUE constraint (matches MySQL UNIQUE column)
ALTER TABLE flow_executions
    ADD CONSTRAINT flow_executions_execution_uuid_uk UNIQUE (execution_uuid);

-- 7. Make id auto-increment in Postgres
CREATE SEQUENCE flow_executions_id_seq
    OWNED BY flow_executions.id;

SELECT setval(
    'flow_executions_id_seq',
    (SELECT MAX(id) FROM flow_executions)
);

ALTER TABLE flow_executions
    ALTER COLUMN id SET DEFAULT nextval('flow_executions_id_seq'),
    ALTER COLUMN id SET NOT NULL;

COMMIT;
