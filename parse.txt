DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'source_schema'
    LOOP
        EXECUTE format(
            'CREATE TABLE target_schema.%I (LIKE source_schema.%I INCLUDING ALL);',
            r.tablename,
            r.tablename
        );

        EXECUTE format(
            'INSERT INTO target_schema.%I SELECT * FROM source_schema.%I;',
            r.tablename,
            r.tablename
        );
    END LOOP;
END $$;


---------------------------------------------------------


BEGIN;

-- 1. Add new columns (nullable initially)
ALTER TABLE flow_executions
    ADD COLUMN id BIGINT,
    ADD COLUMN execution_uuid UUID;

-- 2. Populate new columns deterministically
WITH ordered AS (
    SELECT
        old_id,
        ROW_NUMBER() OVER (ORDER BY created_at ASC) AS new_id
    FROM (
        SELECT id AS old_id, created_at
        FROM flow_executions
    ) t
)
UPDATE flow_executions fe
SET
    id = o.new_id,
    execution_uuid = o.old_id
FROM ordered o
WHERE fe.id = o.old_id;

-- 3. Create and attach sequence
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_class WHERE relname = 'flow_executions_id_seq'
    ) THEN
        CREATE SEQUENCE flow_executions_id_seq
            OWNED BY flow_executions.id;
    END IF;
END $$;

SELECT setval(
    'flow_executions_id_seq',
    (SELECT MAX(id) FROM flow_executions)
);

ALTER TABLE flow_executions
    ALTER COLUMN id SET DEFAULT nextval('flow_executions_id_seq'),
    ALTER COLUMN id SET NOT NULL;

-- 4. Rename category column
ALTER TABLE flow_executions
    RENAME COLUMN category TO flow_group_name;

-- 5. Update foreign key column type
ALTER TABLE pipeline_executions
    ALTER COLUMN flow_execution_id TYPE BIGINT
    USING flow_execution_id::BIGINT;

-- 6. Drop old primary key and add new one
ALTER TABLE flow_executions
    DROP CONSTRAINT flow_executions_pkey;

ALTER TABLE flow_executions
    ADD CONSTRAINT flow_executions_pkey PRIMARY KEY (id);

-- 7. Add uniqueness constraint for preserved UUID
ALTER TABLE flow_executions
    ADD CONSTRAINT flow_executions_execution_uuid_uk UNIQUE (execution_uuid);

-- 8. Recreate foreign key constraint
ALTER TABLE pipeline_executions
    ADD CONSTRAINT pipeline_executions_flow_execution_fk
    FOREIGN KEY (flow_execution_id)
    REFERENCES flow_executions(id);

COMMIT;
